

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Onnx Model tutorial &mdash; OpenDenoising 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Matlab Model tutorial" href="MatlabModel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OpenDenoising
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation guide.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark_api_doc.html">Benchmark API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#in-depth-tutorials">In-depth Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="FilteringModel.html">Filtering Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="KerasModel.html">Keras Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="TfModel.html">Tensorflow Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="PytorchModel.html">Pytorch Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatconvnetModel.html">Matconvnet Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatlabModel.html">Matlab Model tutorial</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Onnx Model tutorial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#onnx-model">Onnx Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#charging-a-model">Charging a model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-inference">Running Inference</a></li>
<li class="toctree-l4"><a class="reference internal" href="#converting-models-to-onnx">Converting models to Onnx</a></li>
<li class="toctree-l4"><a class="reference internal" href="#keras-to-onnx">Keras to Onnx</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pytorch-to-onnx">Pytorch to Onnx</a></li>
<li class="toctree-l4"><a class="reference internal" href="#matlab-to-onnx">Matlab to Onnx</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#jupyter-notebooks">Jupyter Notebooks</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenDenoising</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Onnx Model tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Examples/OnnxModel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="onnx-model-tutorial">
<h1>Onnx Model tutorial<a class="headerlink" href="#onnx-model-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is a part of Model module guide. Here, we explore how you
can use the OnnxModel wrapper to use your Onnx deep learning models in
the benchmark.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">tf2onnx</span>
<span class="kn">import</span> <span class="nn">keras2onnx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matlab.engine</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">evaluation</span>

<span class="n">eng</span> <span class="o">=</span> <span class="n">matlab</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">start_matlab</span><span class="p">()</span>
</pre></div>
</div>
<p>The following function will be used throughout this tutorial to display denoising results,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_images</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display denoising results.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Denoising results using {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ground-Truth&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noised Image&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rest_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Restored Images&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Moreover, you may download the data we will use by using the following function,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">download_BSDS_grayscale</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The models will be evaluated using the BSDS dataset,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Validation images generator</span>
<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Valid&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Valid&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="onnx-model">
<h2>Onnx Model<a class="headerlink" href="#onnx-model" title="Permalink to this headline">¶</a></h2>
<p>This notebook covers how OnnxModel class can be used to hold Deep
Learning models, and to perform inference. We remark that Onnx is a
framework focused on deploying trained neural networks, hence, there is
no support for training models in this format.</p>
</div>
<div class="section" id="charging-a-model">
<h2>Charging a model<a class="headerlink" href="#charging-a-model" title="Permalink to this headline">¶</a></h2>
<p>The charging can only be done by the specification of a “.onnx” file,
which holds the model’s computational graph as well as weights. To
perform inference, we rely on <a class="reference external" href="https://github.com/microsoft/onnxruntime">onnxruntime
module</a> for Python.</p>
<p>After charging a model into OnnxModel, a onnxruntime session is created
so that you can perform inference.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">onnx_model_ex1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">OnnxModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;DnCNN_onnx&quot;</span><span class="p">)</span>
<span class="n">onnx_model_ex1</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Onnx Models/dncnn.onnx&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-inference">
<h2>Running Inference<a class="headerlink" href="#running-inference" title="Permalink to this headline">¶</a></h2>
<p>Inference can be done by using the “__call__” method required by the
AbstractDeepLearningModel interface. This method ensures that derived
classes (as OnnxModel) can be used a function. Bellow, a batch of
noisy/clean images is drawn from the dataset, and the OnnxModel used to
predict the restored image,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">onnx_model_ex1</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="c1"># Display results</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">onnx_model_ex1</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/Onnx_output_15_0.png" src="../_images/Onnx_output_15_0.png" />
</div>
<div class="section" id="converting-models-to-onnx">
<h2>Converting models to Onnx<a class="headerlink" href="#converting-models-to-onnx" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://onnx.ai/">Onnx</a> is thought as a bridge between different
Deep Learning frameworks. It is used to deploy models for inference
(assuming they were trained previously).</p>
<p>Each language has its own way of converting its models into Onnx. Some
of them, such as <a class="reference external" href="https://pytorch.org/docs/stable/onnx.html">Pytorch</a>
and
<a class="reference external" href="https://fr.mathworks.com/help/deeplearning/ref/importonnxnetwork.html">Matlab</a>,
have such support natively. Others, rely on non-official modules such as
<a class="reference external" href="https://github.com/onnx/keras-onnx">keras2onnx</a> or
<a class="reference external" href="https://github.com/onnx/tensorflow-onnx">tf2onnx</a>.</p>
</div>
<div class="section" id="keras-to-onnx">
<h2>Keras to Onnx<a class="headerlink" href="#keras-to-onnx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loads Keras model</span>
<span class="n">keras_model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;./Additional Files/Keras Models/dncnn.hdf5&quot;</span><span class="p">)</span>
<span class="c1"># Converts Keras model to Onnx</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">keras2onnx</span><span class="o">.</span><span class="n">convert_keras</span><span class="p">(</span><span class="n">keras_model</span><span class="p">,</span> <span class="s2">&quot;myModel&quot;</span><span class="p">)</span>
<span class="c1"># Saves Onnx model</span>
<span class="n">onnx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">onnx_model</span><span class="p">,</span> <span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_keras.onnx&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pytorch-to-onnx">
<h2>Pytorch to Onnx<a class="headerlink" href="#pytorch-to-onnx" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loads torch model</span>
<span class="n">torch_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./Additional Files/Pytorch Models/dncnn.pth&quot;</span><span class="p">)</span>
<span class="n">dummy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<span class="n">torch_model</span> <span class="o">=</span> <span class="n">torch_model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
<span class="n">torch</span><span class="o">.</span><span class="n">onnx</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">torch_model</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_pytorch.onnx&quot;</span><span class="p">,</span>
                  <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span> <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loads onnx file from Pytorch</span>
<span class="n">onnx_model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_pytorch.onnx&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Graph Input] name: </span><span class="si">{}</span><span class="s2">, shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">dim_value</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">dim</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Graph Output] name: </span><span class="si">{}</span><span class="s2">, shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                  <span class="p">[</span><span class="n">dim</span><span class="o">.</span><span class="n">dim_value</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">onnx_model</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">tensor_type</span><span class="o">.</span><span class="n">shape</span><span class="o">.</span><span class="n">dim</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Graph</span> <span class="n">Input</span><span class="p">]</span> <span class="n">name</span><span class="p">:</span> <span class="nb">input</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="p">[</span><span class="n">Graph</span> <span class="n">Output</span><span class="p">]</span> <span class="n">name</span><span class="p">:</span> <span class="n">output</span><span class="p">,</span> <span class="n">shape</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
</pre></div>
</div>
<p>Notice that the past two tensors are of fixed size (both batch size,
height and width). We address this problem in the next section.</p>
<div class="section" id="note-on-pytorch2onnx">
<h3>Note on Pytorch2Onnx<a class="headerlink" href="#note-on-pytorch2onnx" title="Permalink to this headline">¶</a></h3>
<p>Since Pytorch does not support <a class="reference external" href="https://github.com/onnx/onnx/issues/654">dynamic
shapes</a> (i.e. None values in
shape), the exported Onnx model will have fixed shape, which can be
problematic at inference (you can only process images by slicing them
into fixed-sized patches).</p>
<p>However, there is a turn-around for such problem, that is to process
Onnx graph and switch the height/width values for “?” values (analogous
to None in Tensorflow/Keras).</p>
<p>If you face problems with fixed-sized inputs, you can use the
model.utils module for conversion:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">onnx_dynamic_shapes</span><span class="p">(</span><span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_pytorch.onnx&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_pytorch_dyn_shapes.onnx&quot;</span><span class="p">,</span>
                                <span class="n">channels_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loads onnx file from Pytorch</span>
<span class="n">onnx_model_dyn_shapes</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_pytorch_dyn_shapes.onnx&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New graph:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Graph Input]</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">onnx_model_dyn_shapes</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[Graph Output] name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">onnx_model_dyn_shapes</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">New</span> <span class="n">graph</span><span class="p">:</span>
<span class="p">[</span><span class="n">Graph</span> <span class="n">Input</span><span class="p">]</span>
 <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;input&quot;</span>
<span class="nb">type</span> <span class="p">{</span>
  <span class="n">tensor_type</span> <span class="p">{</span>
    <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">shape</span> <span class="p">{</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span>
      <span class="p">}</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_value</span><span class="p">:</span> <span class="mi">1</span>
      <span class="p">}</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span>
      <span class="p">}</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">Graph</span> <span class="n">Output</span><span class="p">]</span> <span class="n">name</span><span class="p">:</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;output&quot;</span>
<span class="nb">type</span> <span class="p">{</span>
  <span class="n">tensor_type</span> <span class="p">{</span>
    <span class="n">elem_type</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">shape</span> <span class="p">{</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span>
      <span class="p">}</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_value</span><span class="p">:</span> <span class="mi">1</span>
      <span class="p">}</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span>
      <span class="p">}</span>
      <span class="n">dim</span> <span class="p">{</span>
        <span class="n">dim_param</span><span class="p">:</span> <span class="s2">&quot;?&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="tensorflow-to-onnx">
<h4>Tensorflow to Onnx<a class="headerlink" href="#tensorflow-to-onnx" title="Permalink to this headline">¶</a></h4>
<p>In order to convert a Tensorflow model to Onnx, you need to convert all
its variables to constants. To do so, the <strong>model.utils</strong> module has a
function called <strong>freeze_tf_graph</strong> that converts all the variables in
the <strong>current</strong> Tensorflow graph to constants.</p>
<p>You can either specify a model_file (containing your Tensorflow Model)
to be read and frozen, or let the function get the default graph and
session. In the first case, the default graph is expected to be empty
(that is, you have not previously defined any tensorflow computation).</p>
<p>In this example, we will freeze the Tensorflow model present on
“./Additional Files/Tensorflow Models/from_saved_model”.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that, in the previous sections, we have loaded a graph using Keras.</span>
<span class="c1"># With tf.reset_default_graph, we can reset Tensorflow&#39;s computational graph.</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">freeze_tf_graph</span><span class="p">(</span><span class="n">model_file</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Tensorflow Models/from_saved_model/saved_model.pb&quot;</span><span class="p">,</span>
                            <span class="n">output_filepath</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Tensorflow Models/frozen_model.pb&quot;</span><span class="p">,</span>
                            <span class="n">output_node_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that, in the previous function, we have loaded the graph in saved_model.</span>
<span class="c1"># With tf.reset_default_graph, we can reset Tensorflow&#39;s computational graph.</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pb2onnx</span><span class="p">(</span><span class="n">path_to_pb</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Tensorflow Models/frozen_model.pb&quot;</span><span class="p">,</span>
                    <span class="n">path_to_onnx</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Onnx Models/dncnn_from_tf.onnx&quot;</span><span class="p">,</span>
                    <span class="n">input_node_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">],</span> <span class="n">output_node_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="matlab-to-onnx">
<h2>Matlab to Onnx<a class="headerlink" href="#matlab-to-onnx" title="Permalink to this headline">¶</a></h2>
<p>Once you have trained your model using <a class="reference external" href="https://www.mathworks.com/products/deep-learning.html">Matlab’s Deep Learning
Toolbox</a>, you
should either a network object on your workspace, or a .mat file saved
on a folder.</p>
<p>Taking the last case as example, we consider the file “./Additional
Files/Matlab Models/dncnn_matlab.mat” previously trained. In order to
convert it to Onnx, you can either do it from Python (by using matlab’s
engine) or directly on Matlab. Keep in mind that every command run with
engine.evalc is a pure matlab command.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eng</span><span class="o">.</span><span class="n">evalc</span><span class="p">(</span><span class="s2">&quot;load(&#39;./Additional Files/Matlab Models/dncnn_matlab.mat&#39;);&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Matlab</span><span class="s1">&#39;s Workspace:</span>

<span class="n">Name</span>      <span class="n">Size</span>              <span class="n">Bytes</span>  <span class="n">Class</span>            <span class="n">Attributes</span>

<span class="n">ME</span>        <span class="mi">1</span><span class="n">x1</span>                <span class="mi">1091</span>  <span class="n">MException</span>
<span class="n">net</span>       <span class="mi">1</span><span class="n">x1</span>             <span class="mi">2258128</span>  <span class="n">SeriesNetwork</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eng</span><span class="o">.</span><span class="n">evalc</span><span class="p">(</span><span class="s2">&quot;exportONNXNetwork(net, &#39;./Additional Files/Onnx Models/dncnn_from_matlab_tb.onnx&#39;)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="MatlabModel.html" class="btn btn-neutral float-left" title="Matlab Model tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Eduardo Montesuma, Florian Lemarchand

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>