

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tensorflow Model tutorial &mdash; OpenDenoising 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pytorch Model tutorial" href="PytorchModel.html" />
    <link rel="prev" title="Keras Model tutorial" href="KerasModel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OpenDenoising
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation guide.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmark_api_doc.html">Benchmark API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../examples.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../examples.html#in-depth-tutorials">In-depth Tutorials</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="FilteringModel.html">Filtering Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="KerasModel.html">Keras Model tutorial</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Tensorflow Model tutorial</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#charging-a-model">Charging a model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-a-function">From a function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#from-a-file">From a file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-tf-train-api">Using tf.train API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-savedmodel-api">Using SavedModel API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#running-inference">Running inference</a></li>
<li class="toctree-l4"><a class="reference internal" href="#training-a-tfmodel">Training a TfModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="PytorchModel.html">Pytorch Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatconvnetModel.html">Matconvnet Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="MatlabModel.html">Matlab Model tutorial</a></li>
<li class="toctree-l3"><a class="reference internal" href="OnnxModel.html">Onnx Model tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#jupyter-notebooks">Jupyter Notebooks</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OpenDenoising</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../examples.html">Examples</a> &raquo;</li>
        
      <li>Tensorflow Model tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Examples/TfModel.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="tensorflow-model-tutorial">
<h1>Tensorflow Model tutorial<a class="headerlink" href="#tensorflow-model-tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is a part of Model module guide. Here, we explore how you
can use the TensorflowModel wrapper to use your Tensorflow deep learning
models in the benchmark.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Python packages</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">OpenDenoising</span> <span class="k">import</span> <span class="n">evaluation</span>
</pre></div>
</div>
<p>The following function will be used throughout this tutorial to display denoising results,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_images</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display denoising results.&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Denoising results using {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ground-Truth&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Noised Image&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rest_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Restored Images&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Moreover, you may download the data we will use by using the following function,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">download_BSDS_grayscale</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The models will be evaluated using the BSDS dataset,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Training images generator</span>
<span class="n">train_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Train&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">preprocessing</span><span class="o">=</span><span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">gen_patches</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
                                                            <span class="n">partial</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dncnn_augmentation</span><span class="p">,</span> <span class="n">aug_times</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Train&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Validation images generator</span>
<span class="n">valid_generator</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">DatasetFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./tmp/BSDS500/Valid&quot;</span><span class="p">,</span>
                                             <span class="n">batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                             <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">noise_config</span><span class="o">=</span><span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">gaussian_noise</span><span class="p">:</span> <span class="p">[</span><span class="mi">25</span><span class="p">]},</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s2">&quot;BSDS_Valid&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>To execute multiple models that access the GPU, you need to allow Tensorflow/Keras to allocate memory only when
needed. This is done through,</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ConfigProto</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">gpu_options</span><span class="o">.</span><span class="n">allow_growth</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set_session</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="charging-a-model">
<h2>Charging a model<a class="headerlink" href="#charging-a-model" title="Permalink to this headline">¶</a></h2>
<p>As Keras models, we have two possibilities to build the computational
graph of a Deep Learning model: by using a function, or by using a file.
As the functions for creating Keras Models, the functions used to build
Tensorflow model will construct the operations of your architecture.</p>
<p>Another peculiarity from Tensorflow models is Batch Normalization. As
stated in their
<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/layers/batch_normalization">documentation</a>
a Batch Normalization layer uses a parameter called “training”, that
switches computations between training and evaluation phases. As it
turns out, <a class="reference external" href="https://www.alexirpan.com/2017/04/26/perils-batch-norm.html">this parameter is essential for the performance of your
model</a>,
and since most of Deep Learning architectures involve a Batch
Normalization layer, we assume that every Tensorflow model has a
placeholder holding a boolean to swith between training and inference.</p>
<p>Loading Tensorflow models from files is also simillar to loading Keras
models from files. The way Tensorflow handles pre-trained models depends
on which module it is used. There are two main APIs for doing this,</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/train/Saver">tf.train.Saver
API</a>,
which saves models as checkpoints.</p></li>
<li><p>The <a class="reference external" href="https://www.tensorflow.org/guide/saved_model">SavedModel
API</a>, which adds
abstractions to help when reloading the network’s graph.</p></li>
</ul>
<p>As a remark, we encourage you to use informative names in your
variables, such as “input” for graph’s input, and “output” for its
output.</p>
</div>
<div class="section" id="from-a-function">
<h2>From a function<a class="headerlink" href="#from-a-function" title="Permalink to this headline">¶</a></h2>
<p>Tensorflow does all its work on the background, as it builds a
computational graph that stays in memory whether or not it is attached
to Python’s variables. For instance,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">initial_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MyTestVariable&quot;</span><span class="p">)</span>
<span class="go">tf.Variable &#39;MyTestVariable:0&#39; shape=(5, 1) dtype=float64_ref</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="bp">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">tf</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">GraphKeys</span><span class="o">.</span><span class="n">GLOBAL_VARIABLES</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;MyTestVariable&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="go">tf.Variable &#39;MyTestVariable:0&#39; shape=(5, 1) dtype=float64_ref</span>
</pre></div>
</div>
<p>As we can see, the Tensorflow variable “MyTestVariable” continues in
memory regardless its connection to Python’s variable “a”. Hence, the
model function only needs to build the Tensorflow computational graph.
Once the computational graph is constructed, we may use Tensorflow’s
graph utils to retrieve tensor names. For instance, consider the
following function:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tf_dncnn</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">n_filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">channels_first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tensorflow implementation of dncnn. Implementation was based on https://github.com/wbhu/DnCNN-tensorflow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    depth : int</span>
<span class="sd">        Number of fully convolutional layers in dncnn. In the original paper, the authors have used depth=17 for non-</span>
<span class="sd">        blind denoising and depth=20 for blind denoising.</span>
<span class="sd">    n_filters : int</span>
<span class="sd">        Number of filters on each convolutional layer.</span>
<span class="sd">    kernel_size : int tuple</span>
<span class="sd">        2D Tuple specifying the size of the kernel window used to compute activations.</span>
<span class="sd">    n_channels : int</span>
<span class="sd">        Number of image channels that the network processes (1 for grayscale, 3 for RGB)</span>
<span class="sd">    channels_first : bool</span>
<span class="sd">        Whether channels comes first (NCHW, True) or last (NHWC, False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">n_channels</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">n_channels</span> <span class="o">==</span> <span class="mi">3</span><span class="p">),</span> <span class="s2">&quot;Expected &#39;n_channels&#39; to be 1 or 3, but got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_channels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">channels_first</span><span class="p">:</span>
        <span class="n">data_format</span> <span class="o">=</span> <span class="s2">&quot;channels_first&quot;</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_format</span> <span class="o">=</span> <span class="s2">&quot;channels_last&quot;</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
    <span class="n">is_training</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span> <span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;is_training&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;block1&#39;</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">input_tensor</span><span class="p">,</span>
                                  <span class="n">filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span>
                                  <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
                                  <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                                  <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
                                  <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">layers</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;block</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layers</span><span class="p">):</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                                      <span class="n">filters</span><span class="o">=</span><span class="n">n_filters</span><span class="p">,</span>
                                      <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
                                      <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layers</span><span class="p">,</span>
                                      <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
                                      <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">batch_normalization</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">is_training</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">variable_scope</span><span class="p">(</span><span class="s1">&#39;block</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">depth</span><span class="p">)):</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">conv2d</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                                 <span class="n">filters</span><span class="o">=</span><span class="n">n_channels</span><span class="p">,</span>
                                 <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
                                 <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                                 <span class="n">data_format</span><span class="o">=</span><span class="n">data_format</span><span class="p">,</span>
                                 <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">noise</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">TfModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;TensorflowDnCNN&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../training_logs/Tensorflow&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex1</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">tf_dncnn</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loading</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">model</span> <span class="n">function</span><span class="o">.</span> <span class="n">Be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">train</span> <span class="n">your</span> <span class="n">network</span> <span class="n">before</span> <span class="n">using</span> <span class="n">it</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resets variables and tf graph</span>
<span class="n">tfmodel_ex1</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="section" id="from-a-file">
<h2>From a file<a class="headerlink" href="#from-a-file" title="Permalink to this headline">¶</a></h2>
<p>Saving and restoring tensorflow models from files depend on which API
was used during training, but their outputs are simillar. Bellow, we
cover how we can build a TfModel using each of the APIs.</p>
</div>
<div class="section" id="using-tf-train-api">
<h2>Using tf.train API<a class="headerlink" href="#using-tf-train-api" title="Permalink to this headline">¶</a></h2>
<p>The tf.train API saves Tensorflow’s computational graph is based on the
<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/train/Saver">tf.train.Saver
class</a>. An
instance of such class saves a Tensorflow computational graph in four
files,</p>
<ul class="simple">
<li><p>.ckpt.meta file, which holds the graph structure.</p></li>
<li><p>.ckpt.data file, which holds the variable values.</p></li>
<li><p>.ckpt.index file, which is a table making the correspondence between
tensors and its metadata.</p></li>
<li><p>checkpoint, holds the name of the previous three files.</p></li>
</ul>
<p>In order to restore the model, you can create a saver’s instance by
calling the function
<a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/train/import_meta_graph">tf.train.import_meta_graph</a>,
which takes as input the path to the “.meta” file. Then, you can restore
the graph using the method “restore” from the saver.</p>
<p>These details are hidden from the user, so that you only need to specify
the log folder during training, so that the model is automatically saved
there, and specify the “model_path” parameter in “<strong>charge_model</strong>” so
that the TfModel class can find the files and load them. As an example,
consider the files in “./Additional Files/Tensorflow Models”. There, we
have the four necessary files to rebuild our Tensorflow model.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex2</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">TfModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;TensorflowDnCNN&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../training_logs/Tensorflow&quot;</span><span class="p">)</span>
<span class="n">tfmodel_ex2</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Tensorflow Models/from_checkpoint/model.ckpt.meta&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loading</span> <span class="n">model</span> <span class="n">using</span> <span class="n">Checkpoint</span> <span class="n">API</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">tfmodel_ex2</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tfmodel_ex2</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/tf_output_20_0.png" src="../_images/tf_output_20_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex2</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">254071</span>
</pre></div>
</div>
</div>
<div class="section" id="using-savedmodel-api">
<h2>Using SavedModel API<a class="headerlink" href="#using-savedmodel-api" title="Permalink to this headline">¶</a></h2>
<p>The charging of a Tensorflow model saved through SavedModel API can be
done by passing to model_path the path to the .pb file. We remark that,
following the requirements of the API, you need to have a folder in the
directory called “variables”, that will hold variable values.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex3</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">TfModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;TensorflowDnCNN&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../training_logs/Tensorflow&quot;</span><span class="p">)</span>
<span class="n">tfmodel_ex3</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_path</span><span class="o">=</span><span class="s2">&quot;./Additional Files/Tensorflow Models/from_saved_model/saved_model.pb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loading</span> <span class="n">model</span> <span class="n">using</span> <span class="n">SavedModel</span> <span class="n">API</span><span class="o">.</span>
</pre></div>
</div>
</div>
<div class="section" id="running-inference">
<h2>Running inference<a class="headerlink" href="#running-inference" title="Permalink to this headline">¶</a></h2>
<p>Inference on TfModels can be done as if the instance was a function (the
class implements “<strong>call</strong>”) function, as can be saw bellow, where we
reuse the TfModel loaded before.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get batch from valid_generator</span>
<span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">clean_imgs</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">)</span>
<span class="c1"># Performs inference on noisy images</span>
<span class="n">rest_imgs</span> <span class="o">=</span> <span class="n">tfmodel_ex3</span><span class="p">(</span><span class="n">noisy_imgs</span><span class="p">)</span>
<span class="n">display_results</span><span class="p">(</span><span class="n">clean_imgs</span><span class="p">,</span> <span class="n">noisy_imgs</span><span class="p">,</span> <span class="n">rest_imgs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tfmodel_ex3</span><span class="p">))</span>
</pre></div>
</div>
<img alt="../_images/tf_output_25_0.png" src="../_images/tf_output_25_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex3</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tf</span><span class="o">.</span><span class="n">reset_default_graph</span><span class="p">()</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">249984</span>
</pre></div>
</div>
</div>
<div class="section" id="training-a-tfmodel">
<h2>Training a TfModel<a class="headerlink" href="#training-a-tfmodel" title="Permalink to this headline">¶</a></h2>
<p>To run a training session, you only need to have a training dataset,
such as defined in the DatasetUsage.ipynb. Once you created a
DatasetGenerator for your training images (and possibly, for you
validation images) you can call the “<strong>train</strong>” method from KerasModel
class, which takes the following parameters,</p>
<ul class="simple">
<li><p>train_generator: any instance of a dataset generator class. This
class will yield the data pairs (noisy image, clean image).</p></li>
<li><p>valid_generator: optional. Specify it if you have validation data
available.</p></li>
<li><p>n_epochs: number of training epochs. Default is 100.</p></li>
<li><p>n_stages: number of training batches drawn at random from the dataset
at each training epoch. Default value is 500.</p></li>
<li><p>learning_rate: constant regulating the weight updates in your model.
Default is 1e-3.</p></li>
<li><p>optimizer_name: you can specify the optimizer’s name for you model.
You can do this by lookin at the names in <a class="reference external" href="https://www.tensorflow.org/api_docs/python/tf/train">Tensorflow
documentation</a>.
Default is “AdamOptimizer” optimizer.</p></li>
<li><p>metrics: list of metrics that will be tracked during training. There
are a couple of useful metrics implemented on <strong>evaluation</strong> module
(such as PSNR, SSIM, MSE) but you can also implement your own
following <a class="reference external" href="https://keras.io/metrics/">Keras conventions</a>.</p></li>
<li><p>kcallbacks: list of Keras callbacks. You can either use <a class="reference external" href="https://keras.io/callbacks/">Keras
default callbacks</a> or the callbacks
defined on <a class="reference internal" href="../evaluation_doc.html#module-evaluation" title="evaluation"><code class="xref py py-mod docutils literal notranslate"><span class="pre">evaluation</span></code></a> module.</p></li>
<li><p>loss: a function following the same specification as metrics. It will
be using during optimization as an objective function to be
minimized. You can either use <a class="reference external" href="https://keras.io/losses/">Keras
default losses</a> or the metrics
defined on <a class="reference internal" href="../evaluation_doc.html#module-evaluation" title="evaluation"><code class="xref py py-mod docutils literal notranslate"><span class="pre">evaluation</span></code></a> module.</p></li>
<li><p>valid_steps: number of validation batches drawn at each validation
epoch.</p></li>
</ul>
<p>To show how a Tensorflow model can be trained, consider the training of
a DnCNN as stated on its <a class="reference external" href="https://arxiv.org/pdf/1608.03981.pdf">original
paper</a>:</p>
<ul class="simple">
<li><p>DnCNN for gaussian denoising has depth 17, n_filters 64, kernel_size
(3, 3).</p></li>
<li><p>It is trained on <span class="math notranslate nohighlight">\(40 \times 40\)</span> patches extracted from BSDS
images, corrupted with fixed-variance gaussian noise
(<span class="math notranslate nohighlight">\(\sigma=25\)</span>, for instance).</p></li>
</ul>
<p>For evaluation, we will use a disjoint subset of BSDS, consisting on 68
images which are not present in the training dataset.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating and charging the model</span>
<span class="n">tfmodel_ex4</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">TfModel</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;TensorflowDnCNN&quot;</span><span class="p">,</span> <span class="n">logdir</span><span class="o">=</span><span class="s2">&quot;../../training_logs/Tensorflow&quot;</span><span class="p">)</span>
<span class="n">tfmodel_ex4</span><span class="o">.</span><span class="n">charge_model</span><span class="p">(</span><span class="n">model_function</span><span class="o">=</span><span class="n">tf_dncnn</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Loading</span> <span class="n">model</span> <span class="kn">from</span> <span class="nn">model</span> <span class="n">function</span><span class="o">.</span> <span class="n">Be</span> <span class="n">sure</span> <span class="n">to</span> <span class="n">train</span> <span class="n">your</span> <span class="n">network</span> <span class="n">before</span> <span class="n">using</span> <span class="n">it</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tfmodel_ex4</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_generator</span><span class="o">=</span><span class="n">train_generator</span><span class="p">,</span>
                  <span class="n">valid_generator</span><span class="o">=</span><span class="n">valid_generator</span><span class="p">,</span>
                  <span class="n">n_epochs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                  <span class="n">n_stages</span><span class="o">=</span><span class="mi">465</span><span class="p">,</span>
                  <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
                  <span class="n">optimizer_name</span><span class="o">=</span><span class="s2">&quot;AdamOptimizer&quot;</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">evaluation</span><span class="o">.</span><span class="n">psnr</span><span class="p">,</span>
                           <span class="n">evaluation</span><span class="o">.</span><span class="n">ssim</span><span class="p">,</span>
                           <span class="n">evaluation</span><span class="o">.</span><span class="n">mse</span><span class="p">],</span>
                  <span class="n">kcallbacks</span><span class="o">=</span><span class="p">[</span><span class="n">evaluation</span><span class="o">.</span><span class="n">DnCNNSchedule</span><span class="p">(),</span>
                              <span class="n">evaluation</span><span class="o">.</span><span class="n">CheckpointCallback</span><span class="p">(</span><span class="n">tfmodel_ex4</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s2">&quot;val_PSNR&quot;</span><span class="p">),</span>
                              <span class="n">evaluation</span><span class="o">.</span><span class="n">TensorboardImage</span><span class="p">(</span><span class="n">valid_generator</span><span class="p">,</span> <span class="n">tfmodel_ex4</span><span class="p">)],</span>
                  <span class="n">loss</span><span class="o">=</span><span class="n">evaluation</span><span class="o">.</span><span class="n">mse</span><span class="p">,</span>
                  <span class="n">valid_steps</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="PytorchModel.html" class="btn btn-neutral float-right" title="Pytorch Model tutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="KerasModel.html" class="btn btn-neutral float-left" title="Keras Model tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Eduardo Montesuma, Florian Lemarchand

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>